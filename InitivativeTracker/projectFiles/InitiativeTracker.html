<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Marsland's Marvelous Movement Manager</title>
<style>
  :root {
    --primary: #2c3e50;
    --secondary: #34495e;
    --accent: #f39c12;
    --danger: #e74c3c;
    --success: #2ecc71;
    --text: #ecf0f1;
    --bg: #1e1e1e;
    --highlight: #3c6e71;
  }

  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 20px;
  }

  h1 {
    text-align: center;
    color: var(--accent);
    font-size: 2.5em;
    margin-bottom: 30px;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    background-color: var(--primary);
    padding: 15px;
    border-radius: 10px;
  }

  #controls label {
    margin-right: 10px;
    font-weight: bold;
  }

  #controls input {
    padding: 6px 8px;
    margin-right: 10px;
    border-radius: 5px;
    border: none;
    width: 80px;
  }

  #controls button {
    padding: 8px 14px;
    background-color: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease;
  }

  #controls button:hover {
    background-color: #e67e22;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 25px;
    background-color: var(--secondary);
    border-radius: 10px;
    overflow: hidden;
  }

  th, td {
    padding: 12px;
    text-align: center;
    border-bottom: 1px solid var(--primary);
  }

  th {
    background-color: var(--primary);
    color: var(--accent);
    font-size: 1.1em;
  }

  tr.active-turn {
    background-color: var(--highlight);
    color: #fff;
    font-weight: bold;
  }

  tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  td input[type="number"] {
    width: 60px;
    padding: 5px;
    border-radius: 5px;
    border: none;
    margin-right: 6px;
    background-color: #ecf0f1;
    color: #2c3e50;
  }

  td button {
    background-color: var(--accent);
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    color: white;
    cursor: pointer;
  }

  td button:hover {
    background-color: #e67e22;
  }

  @media screen and (max-width: 768px) {
    #controls {
      flex-direction: column;
      align-items: flex-start;
    }

    #controls input {
      width: 100px;
    }
  }
</style>
</head>
<body>

<h1>Marsland's Marvelous Movement Manager</h1>

<div id="controls">
  <div>
    <label>Name: <input type="text" id="newName"></label>
    <label>HP: <input type="number" id="newHP" value="10" min="0"></label>
    <label>Initiative: <input type="number" id="newInit" value="10"></label>
    <button onclick="addMember()">Add Member</button>
  </div>
  <div>
    <button onclick="prevTurn()">← Previous</button>
    <button onclick="nextTurn()">Next →</button>
    <strong>Round:</strong> <span id="roundDisplay">1</span>
    <button onclick="resetAll()" style="background-color: #c0392b; margin-left: 10px;">Reset Tracker</button>
    <button onclick="resetRounds()" style="background-color: #2980b9;">Reset Rounds</button>
  </div>
</div>

<table id="tracker">
  <thead>
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>HP</th>
      <th>Adjust</th>
      <th>Initiative</th>
      <th>Remove</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script>
  let members = [];
  let currentTurn = 0;
  let roundCount = 1;

  // Load saved data on page load
  window.onload = () => {
    const savedMembers = localStorage.getItem('dnd_members');
    const savedTurn = localStorage.getItem('dnd_currentTurn');
    const savedRound = localStorage.getItem('dnd_round');

    if (savedMembers) {
      try {
        members = JSON.parse(savedMembers);
        if (!Array.isArray(members)) members = [];
      } catch {
        members = [];
      }
    }

    if (savedTurn) {
      const turnIndex = parseInt(savedTurn);
      currentTurn = (!isNaN(turnIndex) && turnIndex < members.length) ? turnIndex : 0;
    }

    if (savedRound) {
      const roundVal = parseInt(savedRound);
      roundCount = !isNaN(roundVal) ? roundVal : 1;
    }

    updateTable();
  };

  function resetRounds() {
    roundCount = 1;
    saveState();
    updateTable();
  }


  function saveState() {
    localStorage.setItem('dnd_members', JSON.stringify(members));
    localStorage.setItem('dnd_currentTurn', currentTurn);
    localStorage.setItem('dnd_round', roundCount);
  }

  function addMember() {
    if (members.length >= 30) {
      alert("Maximum of 30 members reached.");
      return;
    }

    const name = document.getElementById('newName').value.trim();
    const hp = parseInt(document.getElementById('newHP').value);
    const init = parseInt(document.getElementById('newInit').value);

    if (!name || isNaN(hp) || isNaN(init)) {
      alert("Please enter valid name, HP, and initiative.");
      return;
    }

    members.push({ name, hp, init });
    members.sort((a, b) => b.init - a.init);
    currentTurn = 0;
    roundCount = 1;
    saveState();
    updateTable();
  }

  function addHP(index) {
    const input = document.getElementById(`hpChange-${index}`);
    const delta = parseInt(input.value);
    if (!isNaN(delta)) {
      members[index].hp += delta;
      if (members[index].hp < 0) members[index].hp = 0;
    }
    input.value = ''; // clear input
    saveState();
    updateTable();
  }

    function removeHP(index) {
    const input = document.getElementById(`hpChange-${index}`);
    const delta = parseInt(input.value);
    if (!isNaN(delta)) {
      members[index].hp -= delta;
      if (members[index].hp < 0) members[index].hp = 0;
    }
    input.value = ''; // clear input
    saveState();
    updateTable();
  }

  function adjustInit(index) {
    const input = document.getElementById(`initChange-${index}`);
    const newInit = parseInt(input.value);

    if (!isNaN(newInit)) {
      members[index].init = newInit;
      // Preserve current member identity across sort
      const currentMember = members[currentTurn];
      members.sort((a, b) => b.init - a.init);
      currentTurn = members.findIndex(m => m.name === currentMember.name);
      saveState();
      updateTable();
   }
  }


  function removeMember(index) {
    members.splice(index, 1);
    if (currentTurn >= members.length) {
      currentTurn = 0;
    }
    saveState();
    updateTable();
  }

  function nextTurn() {
    if (members.length === 0) return;
    currentTurn = (currentTurn + 1) % members.length;
    if (currentTurn === 0) {
      roundCount += 1;
    }
    saveState();
    updateTable();
  }

  function prevTurn() {
    if (members.length === 0) return;
    currentTurn = (currentTurn - 1 + members.length) % members.length;
    saveState();
    updateTable();
  }

  function resetAll() {
    if (!confirm("Are you sure you want to reset the tracker? This cannot be undone.")) return;

    members = [];
    currentTurn = 0;
    roundCount = 1;
    localStorage.clear();
    updateTable();
  }

  function updateTable() {
    const tbody = document.querySelector('#tracker tbody');
    const roundEl = document.getElementById('roundDisplay');
    if (roundEl) roundEl.textContent = roundCount;

    tbody.innerHTML = '';
    members.forEach((member, index) => {
      const row = document.createElement('tr');
      if (index === currentTurn) row.classList.add('active-turn');

      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${member.name}</td>
        <td>${member.hp}</td>
        <td>
          <input type="number" id="hpChange-${index}" style="width: 60px;" placeholder="+/- HP">
          <button onclick="addHP(${index})">Add</button>
          <button onclick="removeHP(${index})">Remove</button>
        </td>
        <td>
        <input type="number" id="initChange-${index}" value="${member.init}" style="width: 60px;">
        <button onclick="adjustInit(${index})">Update</button>
        </td>
        <td><button onclick="removeMember(${index})" style="background-color: #e74c3c;">Remove</button></td>
      `;
      tbody.appendChild(row);
    });
  }
</script>
</body>
</html>
